#!/usr/bin/env bash

### BEGIN SCRIPT HEADER
SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")
SCRIPT_NAME=$(basename "${SCRIPT_PATH}")
DIR_SCRIPT=$(dirname "${SCRIPT_PATH}")
DIR_ROOT=$(dirname $DIR_SCRIPT)
HELPER="${DIR_ROOT}/01_pwnbox/tools-helper.sh"
source "$HELPER" || exit
### END SCRIPT HEADER

function print_service_status() {  
    systemctl status $1 >/dev/null 2>&1
    case $? in
        0)
            printf " |__ ${COLOR_GREEN_BOLD}%s${COLOR_RST} (running)\n" $1
            ;;
        3)
            printf " |__ ${COLOR_RED_BOLD}%s${COLOR_RST} (stopped)\n" $1
            ;;
        4)
            printf " |__ ${COLOR_CYAN_BOLD}%s${COLOR_RST} (not installed)\n" $1
            ;;
        *)
            printf " |__ ${COLOR_CYAN_BOLD}%s${COLOR_RST} (unknown status)\n" $1
            ;;
    esac
}

function print_listening_ports_4() {
    for lp in $(ss -lpnt4H | awk '{ print $4 }' | sort);
    do
        a=$(echo $lp | cut -d: -f1)
        p=$(echo $lp | cut -d: -f2)
        printf " |__ %s:${COLOR_CYAN_BOLD}${p}${COLOR_RST}\n" $a
    done
}

function print_listening_ports_6() {
    for lp in $(ss -lpnt6H | awk '{ print $4 }' | sort);
    do
        a="$(echo $lp | cut -d']' -f1)]"
        p=$(echo $lp | rev | cut -d: -f1 | rev)
        printf " |__ %s:${COLOR_CYAN_BOLD}${p}${COLOR_RST}\n" $a
    done
}

printf ' ----------------------------------------------------------------\n'

printf " ${COLOR_CYAN_BOLD}Services${COLOR_RST}\n"
print_service_status "open-vm-tools"
print_service_status "snapd"
print_service_status "NetworkManager"
print_service_status "nessusd"
print_service_status "smbd"

printf ' ----------------------------------------------------------------\n'

printf " ${COLOR_CYAN_BOLD}Listening TCP ports${COLOR_RST}\n"
print_listening_ports_4
print_listening_ports_6

printf ' ----------------------------------------------------------------\n'