{ config, pkgs, ... }:
let
  burpsuite-pro = pkgs.burpsuite.override { proEdition = true; };
  settings = {
    hostname = "terminus";
    keymap = "fr";
    timezone = "Europe/Paris";
    username = "itm4n";
  };
in
{
  imports = [
    /etc/nixos/hardware-configuration.nix
    <home-manager/nixos>
  ];

  #
  # Package manager configuration.
  #

  nixpkgs.config.allowUnfree = true;

  #
  # Base system configuration.
  #

  boot.loader.grub.enable = true;
  boot.loader.grub.device = "/dev/vda";
  boot.loader.grub.useOSProber = true;
  time.timeZone = "${settings.timezone}";
  console.keyMap = "${settings.keymap}";

  #
  # Hardware configuration
  #

  hardware.enableRedistributableFirmware = true; # Provides firmware for Wi-Fi cards

  #
  # Network configuration.
  #

  networking.firewall.enable = false;
  networking.hostName = "${settings.hostname}";
  networking.networkmanager.enable = true;

  #
  # Add and configure user account.
  #

  security.sudo.wheelNeedsPassword = false; # No password required for "sudo" users in "wheel".
  users.defaultUserShell = pkgs.zsh; # Set package "zsh" as the default shell.

  programs.zsh = {
    enable = true;
    enableBashCompletion = true;
    enableCompletion = true;
    enableGlobalCompInit = true;
    enableLsColors = true;
  };

  users.groups.wireshark = {}; # Create the group "wireshark" to allow non-root users to use Wireshark.
  users.users.${settings.username} = {
    isNormalUser = true;
    extraGroups = [
      "docker"
      "networkmanager"
      "wheel"
      "wireshark"
    ];
    shell = pkgs.zsh;
  };

  environment.localBinInPath = true; # Add "$HOME/.local/bin" to PATH.

  #
  # System packages
  #
  
  environment.systemPackages = with pkgs; [

    # === Utils ===
    azure-cli # Azure command line interface
    chroma
    chromium
    cifs-utils # Required to mount SMB shares
    coreutils
    cryptsetup # LUKS for dm-crypt
    dhcpcd
    dig
    ent
    file
    firefox
    freerdp
    gcc
    git
    gnumake # A tool to control the generation of non-source files from sources.
    gnupg
    go
    google-cloud-sdk
    gtk3
    gzip
    htop
    iptables
    jq
    jython
    keepass
    killall
    mlocate
    nfs-utils
    oh-my-zsh
    openssl
    openvpn
    oras # The ORAS project provides a way to push and pull OCI Artifacts to and from OCI Registries.
    p7zip
    pavucontrol # PulseAudio Volume Control
    podman # A program for managing pods, containers and container images.
    python311 # Python interpreter
    python311Packages.pip # Pip installer
    python311Packages.pycryptodome
    python311Packages.pycryptodomex # Self-contained cryptographic library
    qemu-utils # Provides commands such as 'qemu-nbd' and 'qemu-img'
    ripgrep
    rlwrap
    ruby
    terminator
    tree
    util-linux
    unzip
    vim
    virtualenv
    vscode
    wget
    which
    xcape # Utility to configure modifier keys to act as other keys
    xclip
    xorg.xhost
    yq-go # Portable command-line YAML processor
    zellij

    # === XFCE ===
    xfce.thunar-volman
    xfce.xfconf
    xfce.xfce4-appfinder
    xfce.xfce4-battery-plugin
    xfce.xfce4-cpufreq-plugin
    xfce.xfce4-cpugraph-plugin
    xfce.xfce4-datetime-plugin
    xfce.xfce4-fsguard-plugin
    xfce.xfce4-genmon-plugin
    xfce.xfce4-netload-plugin
    xfce.xfce4-notifyd
    xfce.xfce4-panel
    xfce.xfce4-panel-profiles
    xfce.xfce4-power-manager
    xfce.xfce4-pulseaudio-plugin
    xfce.xfce4-sensors-plugin
    xfce.xfce4-session
    xfce.xfce4-settings
    xfce.xfce4-systemload-plugin
    xfce.xfce4-taskmanager
    xfce.xfce4-timer-plugin
    xfce.xfce4-verve-plugin
    xfce.xfce4-whiskermenu-plugin
    xfce.xfce4-xkb-plugin

    # === Desktop customization ===
    flat-remix-icon-theme

    # === Python packages ===
    python311Packages.argcomplete

    # === Pentest ===
    aircrack-ng
    apktool
    awscli2
    baobab
    bettercap
    binwalk
    burpsuite-pro
    checksec
    dbeaver-bin
    dnsmasq
    ethtool # Utility for controlling network drivers and hardware (used by Ettercap)
    ettercap
    exegol
    geoip # An API for GeoIP/Geolocation databases (used by Ettercap)
    hashcat
    hostapd
    hostapd-mana
    ike-scan
    john
    macchanger
    masscan
    metasploit
    netdiscover
    nuclei
    rdesktop
    samba4Full
    seclists
    sqlmap
    wfuzz
    wifite2
    wireshark-qt
    wordlists
    wpscan
    zmap
  ];

  #
  # Application configuration
  #

  programs.gnupg.agent.enable = true;

  # Documentation:
  # - https://nixos.org/manual/nixos/stable/options#opt-programs.proxychains.enable
  programs.proxychains = {
    enable = true;
    proxyDNS = true;
    quietMode = true;
    proxies = {
      localsocks = {
        enable = true;
        type = "socks4";
        host = "127.0.0.1";
        port = 1080;
      };
    };
  };

  environment.etc = {
    "nixos/smb-secrets" = {
      text = ''
        username=clement
        domain=WORKGROUP
        passwprd=samba
      '';
      mode = "0440";
    };
  };

  # Documentation:
  # - https://nixos.wiki/wiki/Samba
  fileSystems."/mnt/virtshare" = {
    device = "//192.168.177.1/VirtShare$";
    fsType = "cifs";
    options = let
      automount_opts = "x-systemd.automount,noauto,x-systemd.idle-timeout=60,x-systemd.device-timeout=5s,x-systemd.mount-timeout=5s";
    in ["${automount_opts},credentials=/etc/nixos/smb-secrets,uid=1000,gid=100"];
  };

  # Hack to be able to use Wireshark as a non-root user.
  # Source:
  # - https://github.com/cleverca22/nixos-configs/blob/master/wireshark-no-root.nix
  security.wrappers.dumpcap = {
    source = "${pkgs.wireshark}/bin/dumpcap";
    permissions = "u+xs,g+x";
    owner = "root";
    group = "wireshark";
  };

  # Custom tasks:
  # - Create a Workspace folder in the Home directory
  # - Download Jython standalone JAR (for BurpSuite)
  system.userActivationScripts = {

    # Create symlinks VirtShare -> /mnt/virtshare
    createSymlinks.text = ''
      if [ -d "/mnt/virtshare" -a ! -h "$HOME/VirtShare" ];
      then
        ln -s "/mnt/virtshare" "$HOME/VirtShare"
      fi
    '';

    # Download Pentest Tools
    downloadPentestTools.text = ''
      if [ -d "$HOME/VirtShare/Tools" -a ! -d "$HOME/VirtShare/Tools/Pentest-Tools" ];
      then
        ${pkgs.git}/bin/git clone https://github.com/itm4n/Pentest-Tools "$HOME/VirtShare/Tools/Pentest-Tools";
      fi

      function create_bash_script_symlink() {
        if [ -f "$HOME/VirtShare/Tools/Pentest-Tools/scripts/bash/$1.sh" ];
        then
          ln -fs "$HOME/VirtShare/Tools/Pentest-Tools/scripts/bash/$1.sh" "/home/${settings.username}/.local/bin/$1"
        fi
      }

      create_bash_script_symlink "pt_ap"
      create_bash_script_symlink "pt_masscan"
      create_bash_script_symlink "pt_minidump_lsass"
      create_bash_script_symlink "pt_project"
      create_bash_script_symlink "pt_pwnbox"
    '';

    # Download jython.jar to Tools
    downloadJythonJar.text = ''
      if [ -d "$HOME/VirtShare/Tools" -a ! -f "$HOME/VirtShare/Tools/jython.jar" ];
      then
        ${pkgs.wget}/bin/wget "https://repo1.maven.org/maven2/org/python/jython-standalone/2.7.3/jython-standalone-2.7.3.jar" -O "$HOME/VirtShare/Tools/jython.jar";
      fi
    '';
  };

  #
  # Advanced system configuration
  #

  security.polkit.enable = true;
  security.polkit.extraConfig = ''
    polkit.addRule(function(action, subject) {
        if (subject.isInGroup("wheel")) {
            return polkit.Result.YES;
        }
    });
  '';

  services.displayManager.autoLogin = {
    enable = true;
    user = "${settings.username}";
  };
  services.locate.enable = true;
  services.locate.localuser = null;
  services.locate.package = pkgs.mlocate;
  services.qemuGuest.enable = true;
  services.spice-vdagentd.enable = true;
  services.spice-autorandr.enable = true;
  services.xserver = {
    enable = true;
    xkb.layout = "${settings.keymap}";
    xkb.variant = "";
    displayManager = {
      lightdm.enable = true;
    };
    desktopManager = {
      xfce.enable = true;
      xfce.enableScreensaver = false;
    };
    # Do not enable QXL driver, this seems to be broken on NixOS?! Set 'virtio'
    # as the GPU model in the machine settings instead.
    # videoDrivers = [ "qxl" ];
  };

  virtualisation.docker.enable = true;

  #
  # User profile customization.
  #

  home-manager.users.${settings.username} = { pkgs, ... }: {
    home.stateVersion = "24.05";
    # Hack to enable Ettercap to be used as a non-root user. Polkit policies 
    # on NixOS are broken. In the policy files, the effective path of the
    # binary is used to set "admin_gui" to "true". However, the launcher
    # uses the global path. Because of this mismatch, the policy is not 
    # applied and "admin_gui" remains "false" (default value). With this 
    # value set to "false", the "DISPLAY" environment variable is not 
    # retained, causing the GTK initialization to fail when running the app
    # with pkexec. An issue was opened on GitHub in 2017, and is still
    # unresolved. The following hack consists in creating a custom launcher
    # to pass the environment variables "DISPLAY" and "XAUTHORITY" manually
    # before calling "ettercap -G".
    # - https://github.com/NixOS/nixpkgs/issues/29048
    xdg.desktopEntries = {
      ettercap = {
        name = "Ettercap GUI";
        genericName = "Ettercap GUI";
        exec = "pkexec sh -c \"DISPLAY=:0.0 XAUTHORITY=/home/${settings.username}/.Xauthority ettercap -G\"";
        icon = "ettercap";
        terminal = false;
        type = "Application";
        categories = [ "Network" ];
      };
    };
    xfconf.settings = {
      displays = {
        "Notify" = 0; # Prevents the display settings window to appear when resuming VM
      };
      thunar = {
        "last-view" = "ThunarDetailsView";
        "last-window-width" = 800;
        "last-window-height" = 500;
      };
      xfce4-power-manager = {
        "xfce4-power-manager/blank-on-ac" = 0;
        "xfce4-power-manager/dpms-on-ac-sleep" = 0;
        "xfce4-power-manager/dpms-on-ac-off" = 0;
      };
      xfce4-keyboard-shortcuts = {
        "commands/custom/<Primary>Escape" = "xfce4-popup-whiskermenu";
        "xfwm4/custom/<Super>Up" = "maximize_window_key";
        "xfwm4/custom/<Super>Down" = "hide_window_key";
      };
      xfce4-panel = {
        # Global panel settings
        "panels" = [ 1 ];
        "panels/dark-mode" = true;
        # Configure panel 1
        "panels/panel-1/icon-size" = 0; # Auto size
        "panels/panel-1/length" = 100; # 100% width
        "panels/panel-1/plugin-ids" = [ 201 101 202 203 102 204 103 205 104 206 213 105 207 208 209 210 211 106 212 ];
        "panels/panel-1/position" = "p=6;x=0;y=0";
        "panels/panel-1/position-locked" = true;
        "panels/panel-1/size" = 34;
        # Separator 1: separator
        "plugins/plugin-101" = "separator";
        "plugins/plugin-101/style" = 1;
        "plugins/plugin-101/expand" = false;
        # Separator 2: separator
        "plugins/plugin-102" = "separator";
        "plugins/plugin-102/style" = 1;
        "plugins/plugin-102/expand" = false;
        # Separator 3: separator
        "plugins/plugin-103" = "separator";
        "plugins/plugin-103/style" = 1;
        "plugins/plugin-103/expand" = false;
        # Separator 4: transparent + expand
        "plugins/plugin-104" = "separator";
        "plugins/plugin-104/style" = 0;
        "plugins/plugin-104/expand" = true;
        # Separator 5: separator
        "plugins/plugin-105" = "separator";
        "plugins/plugin-105/style" = 1;
        "plugins/plugin-105/expand" = false;
        # Separator 6: separator
        "plugins/plugin-106" = "separator";
        "plugins/plugin-106/style" = 1;
        "plugins/plugin-106/expand" = false;
        # Configure plugins
        "plugins/plugin-201" = "whiskermenu";
        "plugins/plugin-201/hover-switch-category" = true;
        "plugins/plugin-201/launcher-show-description" = false;
        "plugins/plugin-201/menu-height" = 670;
        "plugins/plugin-201/menu-width" = 570;
        "plugins/plugin-201/position-categories-alternate" = true;
        "plugins/plugin-201/position-profile-alternate" = true;
        "plugins/plugin-201/show-command-lockscreen" = false;
        "plugins/plugin-201/show-command-menueditor" = false;
        "plugins/plugin-201/show-command-profile" = false;
        "plugins/plugin-201/sort-categories" = false;
        "plugins/plugin-201/view-mode" = 2;
        "plugins/plugin-202" = "showdesktop";
        "plugins/plugin-203" = "directorymenu";
        "plugins/plugin-203/base-directory" = "/home/${settings.username}";
        "plugins/plugin-204" = "pager"; # Workspace switcher
        "plugins/plugin-205" = "tasklist"; # Window buttons
        "plugins/plugin-205/grouping" = true;
        "plugins/plugin-205/miniature-view" = true;
        "plugins/plugin-205/numbering" = false;
        "plugins/plugin-205/rows" = 1;
        "plugins/plugin-205/show-handle" = false;
        "plugins/plugin-205/show-labels" = false;
        "plugins/plugin-205/workspace-scrolling" = true;
        "plugins/plugin-205/wrap-workspaces" = false;
        "plugins/plugin-206" = "cpugraph";
        "plugins/plugin-206/background" = [ 1.000000 1.000000 1.000000 0.000000 ];
        "plugins/plugin-206/bars" = 1;
        "plugins/plugin-206/bars-color" = [ 0.000000 1.000000 0.878431 1.000000 ];
        "plugins/plugin-206/border" = 0;
        "plugins/plugin-206/color-mode" = 1; # Gradient
        "plugins/plugin-206/foreground-1" = [ 0.152941 0.466667 1.000000 1.000000 ];
        "plugins/plugin-206/foreground-2" = [ 0.000000 1.000000 0.878431 1.000000 ];
        "plugins/plugin-206/foreground-3" = [ 0.000000 0.000000 1.000000 1.000000 ];
        "plugins/plugin-206/foreground-iowait" = [ 0.200000 0.900000 0.400000 1.000000 ];
        "plugins/plugin-206/foreground-nice" = [ 0.900000 0.800000 0.200000 1.000000 ];
        "plugins/plugin-206/foreground-system" = [ 0.900000 0.100000 0.100000 1.000000 ];
        "plugins/plugin-206/foreground-user" = [ 0.100000 0.400000 0.900000 1.000000 ];
        "plugins/plugin-206/frame" = 0;
        "plugins/plugin-206/in-terminal" = 1;
        "plugins/plugin-206/load-threshold" = 0;
        "plugins/plugin-206/mode" = 1;
        "plugins/plugin-206/per-core" = 0;
        "plugins/plugin-206/per-core-spacing" = 1;
        "plugins/plugin-206/size" = 128;
        "plugins/plugin-206/smt-issues" = 0;
        "plugins/plugin-206/smt-issues-color" = [ 0.900000 0.000000 0.000000 1.000000 ];
        "plugins/plugin-206/smt-stats" = 0;
        "plugins/plugin-206/startup-notification" = 0;
        "plugins/plugin-206/time-scale" = 0;
        "plugins/plugin-206/tracked-core" = 0;
        "plugins/plugin-206/update-interval" = 0;
        "plugins/plugin-207" = "systray";
        "plugins/plugin-207/square-icons" = true;
        "plugins/plugin-208" = "pulseaudio";
        "plugins/plugin-208/enable-keyboard-shortcuts" = true;
        "plugins/plugin-209" = "notification-plugin";
        "plugins/plugin-210" = "power-manager-plugin";
        "plugins/plugin-211" = "clock";
        "plugins/plugin-211/digital-layout" = 1;
        "plugins/plugin-212" = "actions";
        "plugins/plugin-212/appearance" = 0;
        "plugins/plugin-212/items" = [ "+lock-screen" "-switch-user" "-separator" "-suspend" "-hibernate" "-hybrid-sleep" "-separator" "-shutdown" "-restart" "-separator" "+logout" "-logout-dialog" ];
        "plugins/plugin-213" = "fsguard";
      };
      xfce4-session = {
        "general/AutoSave" = false;
      };
      xsettings = {
        "Net/ThemeName" = "Adwaita-dark";
        "Net/IconThemeName" = "Flat-Remix-Blue-Dark";
        "Xfce/SyncThemes" = true;
      };
    };
    # Documentation:
    # - https://nix-community.github.io/home-manager/options.xhtml#opt-programs.terminator.config
    programs.terminator.enable = true;
    programs.terminator.config = {
      global_config.smart_copy = false;
      global_config.suppress_multiple_term_dialog = true;
      keybindings.broadcast_off = "<Alt>o";
      keybindings.broadcast_all = "<Alt>a";
      profiles.default.icon_bell = false;
      profiles.default.cursor_fg_color = "#000000";
      profiles.default.cursor_bg_color = "#aaaaaa";
      profiles.default.font = "Monospace 10";
      profiles.default.scrollback_infinite = true;
      profiles.default.disable_mousewheel_zoom = true;
      profiles.default.use_system_font = false;
      profiles.default.use_theme_colors = true;
      profiles.default.title_use_system_font = false;
      layouts.default.child0.type = "Window";
      layouts.default.child0.parent = "";
      layouts.default.child0.maximised = true;
      layouts.default.child0.fullscreen = false;
      layouts.default.child0.last_active_window = true;
      layouts.default.child0.last_active_term = "08311a57-5592-4d6a-9790-260adac31f40";
      layouts.default.child1.type = "VPaned";
      layouts.default.child1.parent = "child0";
      layouts.default.child1.ratio = "0.5";
      layouts.default.child2.type = "HPaned";
      layouts.default.child2.parent = "child1";
      layouts.default.child2.ratio = "0.5";
      layouts.default.child3.type = "HPaned";
      layouts.default.child3.parent = "child1";
      layouts.default.terminal0.type = "Terminal";
      layouts.default.terminal0.parent = "child2";
      layouts.default.terminal0.profile = "default";
      layouts.default.terminal0.uuid = "08311a57-5592-4d6a-9790-260adac31f40";
      layouts.default.terminal1.type = "Terminal";
      layouts.default.terminal1.parent = "child2";
      layouts.default.terminal1.profile = "default";
      layouts.default.terminal1.uuid = "a29408d8-4cf8-4cbb-93d0-4d4c2698c4f2";
      layouts.default.terminal2.type = "Terminal";
      layouts.default.terminal2.parent = "child3";
      layouts.default.terminal2.profile = "default";
      layouts.default.terminal2.uuid = "ae8ae48c-b783-4ab6-9053-f3a82896b0a9";
      layouts.default.terminal3.type = "Terminal";
      layouts.default.terminal3.parent = "child3";
      layouts.default.terminal3.profile = "default";
      layouts.default.terminal3.uuid = "7b7cc0bb-81bf-4dc2-8bc1-aaa9acd0a49c";
    };
    # Documentation:
    # - https://nixos.wiki/wiki/Zsh
    # - https://nix-community.github.io/home-manager/options.xhtml#opt-programs.zsh.enable
    programs.zsh = {
      enable = true;
      autocd = true;
      autosuggestion.enable = true;
      enableCompletion = true;
      syntaxHighlighting.enable = true;
      history = {
        expireDuplicatesFirst = true;
        ignoreDups = true;
        ignorePatterns = [ "reboot" ];
        ignoreSpace = true;
        share = false;
      };
      oh-my-zsh = {
        enable = true;
        plugins = [ "colored-man-pages" "colorize" "docker" "docker-compose" "git" "nmap" "virtualenv" ];
        theme = "bira";
        extraConfig = ''
          eval "$(register-python-argcomplete --no-defaults exegol)"
        '';
      };
    };
  };

  #
  # System state version
  #

  system.stateVersion = "24.05";
}