#!/usr/bin/env bash

### BEGIN SCRIPT HEADER
SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")
SCRIPT_NAME=$(basename "${SCRIPT_PATH}")
DIR_SCRIPT=$(dirname "${SCRIPT_PATH}")
DIR_ROOT=$(dirname $DIR_SCRIPT)
HELPER="${DIR_ROOT}/01_pwnbox/tools-helper.sh"
source "$HELPER" || exit
### END SCRIPT HEADER

### BEGIN COMMON
function print_usage_and_exit() {
    print_info "Usage: ${SCRIPT_NAME} <HOSTNAME>"
    exit
}

check_argc $# 1 || print_usage_and_exit
### END COMMON

MACHINE_NAME=$(echo "${1}" | tr '[:lower:]' '[:upper:]')
FILE_LSASS="./loot/${MACHINE_NAME}_lsass.bin"
FILE_OUTPUT="./loot/${MACHINE_NAME}_lsass.txt"

if [ -f "${FILE_OUTPUT}" ]
then
    print_error "Output file already exists: ${FILE_OUTPUT}"
    exit
fi

COMMAND="${TOOL_PYPYKATZ} lsa minidump"

if [ -f "${FILE_LSASS}" ]
then
    COMMAND="${COMMAND} '${FILE_LSASS}'"
else
    print_error "Minidump file not found: ${FILE_LSASS}"
    exit
fi

eval ${COMMAND} | tee "${FILE_OUTPUT}"

print_info "Output save to: ${FILE_OUTPUT}"
