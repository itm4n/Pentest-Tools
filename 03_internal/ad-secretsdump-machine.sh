#!/usr/bin/env bash

### BEGIN SCRIPT HEADER
SCRIPT_NAME=$(basename "${BASH_SOURCE[0]}")
DIR_SCRIPT=$(dirname "${BASH_SOURCE[0]}")
DIR_ROOT=$(dirname $DIR_SCRIPT)
HELPER="${DIR_ROOT}/01_pwnbox/tools-helper.sh"
source "$HELPER" || exit
### END SCRIPT HEADER

### BEGIN COMMON
function print_usage_and_exit() {
    print_info "Usage: ${SCRIPT_NAME} <HOSTNAME>"
    exit
}

check_argc $# 1 || print_usage_and_exit
### END COMMON

MACHINE_NAME=$(echo "${1}" | tr '[:lower:]' '[:upper:]')
FILE_SAM="./loot/${MACHINE_NAME}_sam.bin"
FILE_SYSTEM="./loot/${MACHINE_NAME}_system.bin"
FILE_SECURITY="./loot/${MACHINE_NAME}_security.bin"
FILE_OUTPUT="./loot/${MACHINE_NAME}_secrets.txt"

COMMAND="${TOOL_IMPACKET_SECRETSDUMP}"

if [ -f "${FILE_OUTPUT}" ]
then
    print_error "Output file already exists: ${FILE_OUTPUT}"
    exit
fi

if [ -f $FILE_SYSTEM ]
then
    COMMAND="${COMMAND} -system '${FILE_SYSTEM}'"
else
    print_error "SYSTEM file not found: ${FILE_SYSTEM}"
    exit
fi

if [ -f $FILE_SAM ]
then
    COMMAND="${COMMAND} -sam '${FILE_SAM}'"
else
    print_warning "SAM file not found: ${FILE_SAM}"
fi

if [ -f $FILE_SECURITY ]
then
    COMMAND="${COMMAND} -security '${FILE_SECURITY}'"
else
    print_warning "SECURITY file not found: ${FILE_SECURITY}"
fi

COMMAND="${COMMAND} LOCAL"

eval ${COMMAND} | tee "${FILE_OUTPUT}"

print_info "Output save to: ${FILE_OUTPUT}"
